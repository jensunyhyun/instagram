define(["jquery","common/utils/validationUtils"],function($,validator){var MenuSelector=function(options){this.defaultPosition={x:-1,y:-1};this.activeTarget=null;this.standbyTimer=null;this.mousePos=[];this.fixedRectangle=false;this.delayTime=200;this.tolerance=0;this.init(options)};MenuSelector.prototype={init:function(options){this.$menuPanel=$(options.menuPanelSelector);this.menuRowSelector=options.menuRowSelector;this.targetSelector=options.targetSelector;this.handlers={standby:options.standbyHandler,
clear:options.clearHandler,active:options.activeHandler,deactive:options.deactiveHandler};this.fixedRectangle=options.fixedRectangle;this.delayTime=options.delayTime;this.tolerance=options.tolerance==null?0:options.tolerance;this.eventPoint=this.defaultPosition;this.bindEvent();if(this.fixedRectangle)this.resetRectangle();else this.defaultRectangle()},bindEvent:function(){this.$menuPanel.mousemove($.proxy(this.mousemove,this));this.$menuPanel.on("mouseenter",this.menuRowSelector,$.proxy(this.mouseenter,
this));this.$menuPanel.on("mouseleave",this.menuRowSelector,$.proxy(this.mouseleave,this))},defaultRectangle:function(){this.rectangle={leftTop:this.defaultPosition,leftBottom:this.defaultPosition,rightTop:this.defaultPosition,rightBottom:this.defaultPosition}},resetRectangle:function(){var $target=$(this.targetSelector);if(validator.isEmpty($target)){this.defaultRectangle();return}var offset=$target.offset();var width=$target.outerWidth();var height=$target.outerHeight();this.rectangle={leftTop:{x:offset.left,
y:offset.top-this.tolerance},leftBottom:{x:offset.left,y:offset.top+height+this.tolerance},rightTop:{x:offset.left+width,y:offset.top-this.tolerance},rightBottom:{x:offset.left+width,y:offset.top+height+this.tolerance}}},mousemove:function(e){this.mousePos.push({x:e.pageX,y:e.pageY});if(this.mousePos.length>3)this.mousePos.shift();if(this.eventPoint.x>e.pageX)this.eventPoint.x=e.pageX},mouseenter:function(e){this.clearDelay();if(this.pointInTriangle(this.mousePos[2]))this.lazyAction(e);else this.instantlyAction(e)},
mouseleave:function(e){this.clearDelay();if(!this.pointInTriangle(this.mousePos[2])){this.handlers.clear(e);this.handlers.deactive(e,this.activeTarget);this.eventPoint=this.defaultPosition}},isDownDirection:function(){if(validator.isEmpty(this.mousePos[2]))return false;return this.mousePos[0].y<this.mousePos[2].y},isUpDirection:function(){if(validator.isEmpty(this.mousePos[2]))return false;return this.mousePos[0].y>this.mousePos[2].y},clearDelay:function(){clearTimeout(this.standbyTimer)},lazyAction:function(e){var _this=
this;this.handlers.standby(e);this.standbyTimer=setTimeout(function(){_this.handlers.clear(e);_this.handlers.deactive(e,_this.activeTarget);_this.instantlyAction(e)},this.delayTime)},instantlyAction:function(e){this.activeTarget=e.currentTarget;this.handlers.active(e,this.activeTarget);this.eventPoint=validator.defaultValue(this.mousePos[2],this.defaultPosition);if(this.isDownDirection())this.eventPoint.y+=$(e.currentTarget).height()/2;else if(this.isUpDirection())this.eventPoint.y-=$(e.currentTarget).height()/
2;if(!this.fixedRectangle)this.resetRectangle()},pointInTriangle:function(point){if(this.eventPoint.x<0||this.eventPoint.y<0)return false;var basePoint=this.selectPossiblePoint(point);var c1=this.checkSign(point,this.eventPoint,basePoint.top);var c2=this.checkSign(point,basePoint.top,basePoint.bottom);var c3=this.checkSign(point,basePoint.bottom,this.eventPoint);return c1==c2&&c2==c3},selectPossiblePoint:function(point){return{top:point.y<this.rectangle.leftTop.y?this.rectangle.rightTop:this.rectangle.leftTop,
bottom:point.y>this.rectangle.leftBottom.y?this.rectangle.rightBottom:this.rectangle.leftBottom}},checkSign:function(p1,p2,p3){return(p1.x-p3.x)*(p2.y-p3.y)<(p2.x-p3.x)*(p1.y-p3.y)}};return MenuSelector});