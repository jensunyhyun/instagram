define(["jquery","common/template/urlBuilder","common/utils/validationUtils","common/reporter/gaToWiseLogMaker","common/reporter/queryStringAppender","common/template/search/SearchAdKeyword","common/template/search/SearchKeywordPopupLayer","common/utils/browserChecker","common/utils/cookieUtils","common/essentialData","couLog","search/searchWebLogSchemas","search/utils/weblogUtils-min"],function($,urlBuilder,validationUtils,gaToWiseLogMaker,queryStringAppender,SearchAdKeyword,SearchKeywordPopupLayer,
browserChecker,cookie,essentialData,couLog,searchWebLogSchemas,weblogUtils){var KeywordSearch=function(targetInfo){this.$searchForm=$(targetInfo.searchForm);this.$subminBtn=$(targetInfo.submitBtn);this.$inputTarget=$(targetInfo.inputTarget);this.$popupLayer=$(targetInfo.popupLayerElement);this.$categories=$(targetInfo.categoriesElement);this.$searchChannel=this.$searchForm.find("input[name\x3d'channel']");this.searchAdKeyword=new SearchAdKeyword(targetInfo);this.searchKeywordPopupLayer=new SearchKeywordPopupLayer(targetInfo);
this.isRequested=false};var LOG_PARAMS=searchWebLogSchemas.LOG_PARAMS||{};KeywordSearch.prototype={init:function(){this.bindSearchEvent();this.searchAdKeyword.init();this.speechSearch();this.categorySearch()},bindSearchEvent:function(){this.$searchForm.on("submit",$.proxy(function(){var query=$.trim(this.$inputTarget.val());var channel=this.$searchChannel.val();var data=this.$searchChannel.data();var autoCompletedKeyword=data&&{"rank":data.rank,"prefix":data.prefix||""};var log={"logCategory":"event",
"logType":"click","logLabel":"SRP","q":query},logAuto={"customURL":"/click_search_autocomplete_keyword"},logRecent={"customURL":"/click_search_recent_keyword"},logUser={"customURL":"/click_search_list","channel":"user"};var weblog={};switch(channel){case "auto":$.extend(log,logAuto,autoCompletedKeyword);$.extend(true,weblog,LOG_PARAMS.SRP_AUTOCOMPLETE_CLICK);$.extend(weblog.data,autoCompletedKeyword,{q:query});break;case "recent":$.extend(log,logRecent);$.extend(true,weblog,LOG_PARAMS.SRP_HISTORY_CLICK);
$.extend(weblog.data,{q:query});break;case "user":default:$.extend(log,logUser);$.extend(true,weblog,LOG_PARAMS.SRP_SEARCH_BUTTON_CLICK);$.extend(weblog.data,{q:query});break}if(!query)return false;if(!this.isRequested){this.isRequested=true;if(this.searchAdKeyword.isExecutableSearchAdKeywordEvent())this.searchAdKeyword.executeSearchAdKeywordEvent();else{this.$inputTarget.val(query);this.setCookieHistory();if(channel)try{couLog.execManualLogging(log);weblogUtils.sendLog(weblog)}catch(e){}this.submitSearchKeyword()}return false}},
this));this.$inputTarget.on("keyup",$.proxy(function(e){var keyCode=e.which;if(keyCode==229)e.preventDefault();else if(keyCode===38)this.searchKeywordPopupLayer.upKeyButtonInPopupLayerEvent(this.$inputTarget);else if(keyCode===40)this.searchKeywordPopupLayer.downKeyButtonInPopupLayerEvent(this.$inputTarget);else if(keyCode==27)this.searchKeywordPopupLayer.closePopupSearchKeyword();else if(browserChecker.isFirefox()==false)this.inputEventHandler()},this));this.$inputTarget.on("input",$.proxy(function(){if(browserChecker.isFirefox())this.inputEventHandler()},
this));this.$inputTarget.on("focusin",$.proxy(function(e){this.$inputTarget.removeClass("ad-keyword");this.searchKeywordPopupLayer.closePopupSearchKeyword();if(validationUtils.isEmpty(this.$inputTarget.val()))this.searchKeywordPopupLayer.renderingSearchKeywordHistory();else if(this.searchAdKeyword.isSearchAdKeyword()){this.$inputTarget.val("");this.searchKeywordPopupLayer.renderingSearchKeywordHistory()}else this.searchKeywordPopupLayer.renderingAutoCompleteSearchKeyword()},this));$(document).on("click",
$.proxy(function(e){if($(e.target).hasClass("coupang-search"))return;var inputKeyword=this.$inputTarget.val();if(!$(e.target).is(".delete-kwdhistory, .history-onoff"))this.searchKeywordPopupLayer.closePopupSearchKeyword();if(validationUtils.isEmpty(inputKeyword))this.$inputTarget.addClass("ad-keyword")},this));$(".delete-kwdhistory").on("click",$.proxy(function(e){e.stopPropagation()},this));this.$subminBtn.on("click",$.proxy(function(){this.$searchForm.trigger("submit")},this))},setCookieHistory:function(){if(cookie.getValue("search-history")!=
"OFF"){var str=this.$inputTarget.val();var check=/[\{\}\[\]\/?.,;:|\)*~`!^\-_+<>@\#$%&\\\=\(\'\"]/gi;if(!check.test(str)){cookie.addCookie("searchKeyword",this.$inputTarget.val(),"|",{timeValue:10});var isTravelKeyword=false;this.$popupLayer.find("[data-travel\x3dtrue]").each(function(index,ele){var travelKeyword=$(ele).data("searchkeyword").replace(/\s/g,"");if(travelKeyword===str.replace(/\s/g,"")){isTravelKeyword=true;return false}});var searchKeywordType={};searchKeywordType[str]=isTravelKeyword&
1;cookie.addCookie("searchKeywordType",JSON.stringify(searchKeywordType),"|",{timeValue:10})}}},submitSearchKeyword:function(){var category=this.searchCategories.getCategoryLinkCode();var channel=this.$searchChannel.val();if(category>0&&category!=="91018")this.searchCategories.getComponentId(category,$.proxy(function(sLinkCode,nComponent){this.searchCategories.setComponentValue(sLinkCode,nComponent);this.$searchForm.submit()},this));else{var keyword=this.$inputTarget.val()||"";var isTravelKeyword=
false;this.$popupLayer.find("[data-travel\x3dtrue]").each(function(index,ele){var travelKeyword=$(ele).data("searchkeyword").replace(/\s/g,"");if(travelKeyword===keyword.replace(/\s/g,"")){isTravelKeyword=true;return false}});if(isTravelKeyword)window.location.href=this.searchKeywordPopupLayer.buildSearchKeywordUrlWithChannel(encodeURIComponent(keyword),channel,true);else{this.searchCategories.setComponentValue("","");this.$searchForm.submit()}}},isCoupangWeb:function(){var isMycoupang=location.href.match("my.coupang")?
true:false;var isLogin=location.href.match("login.coupang")?true:false;var isSubscribeOrder=location.href.match("subscribe-order.coupang")?true:false;if(!isMycoupang&&!isLogin&&!isSubscribeOrder)return true;return false},speechSearch:function(){coupangWebRequire(["common/template/search/speech/speech-recognizer"],function(speechRecognizer){new speechRecognizer({textarea:"#headerSearchKeyword",textareaID:"headerSearchKeyword",insertTarget:".header-searchForm"})})},categorySearch:function(){coupangWebRequire(["common/template/search/SearchCategories"],
$.proxy(function(SearchCategories){this.searchCategories=new SearchCategories({category:this.$categories,popupLayer:this.$popupLayer})},this))},inputEventHandler:function(){this.searchKeywordPopupLayer.setPreSearchKeyword(this.$inputTarget.val());if(validationUtils.isNotEmpty(this.$inputTarget.val()))this.searchKeywordPopupLayer.renderingAutoCompleteSearchKeyword();else this.searchKeywordPopupLayer.renderingSearchKeywordHistory()}};return KeywordSearch});